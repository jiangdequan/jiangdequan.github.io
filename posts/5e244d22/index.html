<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content=""><meta name="author" content="Jiang Dequan"><meta name="theme-color" content="#00bcd4"><link rel="icon" href="https://i.loli.net/2020/02/08/cj1rvKdSJmw5Q2W.png"><link rel="icon" sizes="192x192" href="https://i.loli.net/2020/02/08/cj1rvKdSJmw5Q2W.png"><link rel="shortcut icon" href="https://i.loli.net/2020/02/08/cj1rvKdSJmw5Q2W.png"><link rel="apple-touch-icon" href="https://i.loli.net/2020/02/08/cj1rvKdSJmw5Q2W.png"><link rel="apple-touch-icon" sizes="72x72" href="https://i.loli.net/2020/02/08/cj1rvKdSJmw5Q2W.png"><link rel="apple-touch-icon" sizes="144x144" href="https://i.loli.net/2020/02/08/stLfZP76Y1JGKR2.png"><link rel="apple-touch-icon" sizes="180x180" href="https://i.loli.net/2020/02/08/uj1IvT6se8BZMgx.png"><title>JavaHub | A Lost Programmer In The World</title><link href="https://cdn.bootcss.com/font-awesome/5.4.1/css/all.css" rel="stylesheet"><link href="https://cdn.bootcss.com/mdui/0.4.1/css/mdui.min.css" rel="stylesheet"><link rel="stylesheet" href="/css/common.css"><script src="https://cdn.bootcss.com/jquery/2.2.3/jquery.min.js"></script></head><body class="mdui-theme-primary-indigo mdui-theme-accent-indigo mdui-appbar-with-toolbar mdui-drawer-body-right"><div class="simple-appbar mdui-appbar-fixed"><div class="mdui-toolbar mdui-color-indigo"> <a href="javascript:;" class="mdui-btn mdui-btn-icon" id="simple-toggle-menu"><i class="mdui-icon material-icons">&#xe5d2;</i></a> <a href="/" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">&#xe88a;</i></a><div class="mdui-text-center simple-header-title-cls" id="simple-header-title"><small href="javascript:;" class="mdui-typo-title"></small></div><div class="mdui-toolbar-spacer"></div><div class="mdui-textfield mdui-textfield-expandable mdui-float-right simple-searchbar"> <button class="mdui-textfield-icon mdui-btn mdui-btn-icon simple-white-btn"> <i class="mdui-icon material-icons">search</i></button> <input class="mdui-textfield-input" type="text" placeholder="Search" id="simple-input-search"> <button class="mdui-textfield-close mdui-btn mdui-btn-icon simple-white-btn"> <i class="mdui-icon material-icons">close</i></button></div></div></div><div class="mdui-drawer mdui-drawer-full-height mdui-drawer-close mdui-color-white simple-menu-cls" id="simple-menu"> <a href="https://github.com/jiangdequan/hexo-theme-mdui" title="Fork me on GitHub" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#3f51b5;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><div class="simple-menu-author"> <a href="/"><img class="mdui-img-circle" src="https://i.loli.net/2020/02/08/yWNnZphULOdkxjf.png"></a><div class="mdui-typo-title"> Jiang Dequan <a href="/atom.xml" title="RSS"><i class="mdui-icon material-icons">&#xe0e5;</i></a></div><p>jiangdequan1314@gmail.com</p></div><ul class="mdui-list mdui-typo"><li class="mdui-list-item mdui-ripple mdui-valign"> <a href="/"><i class="mdui-list-item-icon mdui-icon material-icons">&#xe88a;</i> <span>&nbsp;&nbsp;Home</span></a></li><li class="mdui-list-item mdui-ripple"> <a href="/archives"><i class="mdui-list-item-icon mdui-icon material-icons">&#xe865;</i> <span>&nbsp;&nbsp;Archives</span></a></li><li class="mdui-list-item mdui-ripple"> <a href="/categories"><i class="mdui-list-item-icon mdui-icon material-icons">&#xe164;</i> <span>&nbsp;&nbsp;Categories</span></a></li><li class="mdui-list-item mdui-ripple"> <a href="/tags"><i class="mdui-list-item-icon mdui-icon material-icons">&#xe54e;</i> <span>&nbsp;&nbsp;Tags</span></a></li><li class="mdui-list-item mdui-ripple"><a href="https://github.com/jiangdequan" target="_blank"><i class="mdui-list-item-icon mdui-icon fab fa-github"></i> <span>&nbsp;&nbsp;GitHub</span></a></li><li class="mdui-list-item mdui-ripple"> <a href="/about"><i class="mdui-list-item-icon mdui-icon material-icons">&#xe87c;</i> <span>&nbsp;&nbsp;About</span></a></li><li class="mdui-list-item mdui-ripple"> <i class="mdui-icon material-icons">&#xe8f4;</i><div class="mdui-list-item-content"><span id="busuanzi_container_site_pv"><span id="busuanzi_value_site_pv"></span></span></div> <i class="mdui-icon material-icons">&#xe851;</i><div class="mdui-list-item-content"><span id="busuanzi_container_site_uv"><span id="busuanzi_value_site_uv"></span></span></div></li><li class="mdui-list-item mdui-ripple"> <i class="mdui-icon material-icons">&#xe02f;</i><div class="mdui-list-item-content"> <span>共 10 篇</span></div> <i class="mdui-icon material-icons">&#xe24b;</i><div class="mdui-list-item-content"> <span>共 10.1k 字</span></div></li></ul></div><div class="mdui-container-fluid"><div class="simple-post-header"></div><div class="mdui-row" style="margin-top:-110px;z-index:9999"><div class="mdui-card mdui-col-md-7 mdui-col-offset-md-1 mdui-col-xs-12 mdui-shadow-12 simple-post-cls" id="simple-post"><div class="mdui-card-content mdui-typo"><h1>如何创建随机数？</h1> <small class="mdui-typo-body-2-opacity mdui-m-b-1 simple-post-date">2018年12月24日</small><div class="mdui-center mdui-text-center"> <span id="busuanzi_container_page_pv"><del>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</del> 阅读量<span id="busuanzi_value_page_pv"></span> <del>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</del></span></div><br><div class="mdui-m-b-2 simple-content"><p>如何生成随机数？在多线程场景下如何高效地生成随机数？<br><a id="more"></a></p><h2 id="随机数"><a href="#随机数" class="headerlink" title="随机数"></a>随机数</h2><p>随机数最重要的特性是它在产生时后面的那个数与前面的那个数毫无关系。<br>真正的随机数是使用物理现象产生的：比如掷钱币、骰子、转轮、使用电子组件的噪音、核裂变等等。这样的随机数生成器叫做物理性随机数生成器，它们的缺点是技术要求比较高。<br>在实际应用中往往使用伪随机数就足够了。这些数列是“似乎”随机的数，实际上它们是通过一个固定的、可以重复的计算方法产生的。它们不真正地随机，因为它们实际上是可以计算出来的，但是它们具有类似于随机数的统计特征。这样的生成器叫做伪随机数生成器。</p><h2 id="举例说明"><a href="#举例说明" class="headerlink" title="举例说明"></a>举例说明</h2><p>以下示例代码（生成 10 以内的随机整数）包含了常用的生成随机数的用法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> io.github.youmaycallmev.random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.security.SecureRandom;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadLocalRandom;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RandomTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Random RANDOM = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 固定seed的Random */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Random RANDOM_FIXED_SEED = <span class="keyword">new</span> Random(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 固定seed的Random */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Random RANDOM_FIXED_SEED2 = <span class="keyword">new</span> Random(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        byRandom();</span><br><span class="line">        System.out.println(<span class="string">"cost: "</span> + (System.currentTimeMillis() - start));</span><br><span class="line"></span><br><span class="line">        start = System.currentTimeMillis();</span><br><span class="line">        byRandomFixedSeed();</span><br><span class="line">        System.out.println(<span class="string">"byRandomFixedSeed cost: "</span> + (System.currentTimeMillis() - start));</span><br><span class="line"></span><br><span class="line">        start = System.currentTimeMillis();</span><br><span class="line">        byMath();</span><br><span class="line">        System.out.println(<span class="string">"byMath cost: "</span> + (System.currentTimeMillis() - start));</span><br><span class="line"></span><br><span class="line">        start = System.currentTimeMillis();</span><br><span class="line">        byThreadLocalRandom();</span><br><span class="line">        System.out.println(<span class="string">"byThreadLocalRandom cost: "</span> + (System.currentTimeMillis() - start));</span><br><span class="line"></span><br><span class="line">        start = System.currentTimeMillis();</span><br><span class="line">        bySecureRandom();</span><br><span class="line">        System.out.println(<span class="string">"bySecureRandom cost: "</span> + (System.currentTimeMillis() - start));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">byRandom</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            System.out.print(RANDOM.nextInt(<span class="number">10</span>) + <span class="string">"\t"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">byRandomFixedSeed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            System.out.print(RANDOM_FIXED_SEED.nextInt(<span class="number">10</span>) + <span class="string">"\t"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            System.out.print(RANDOM_FIXED_SEED2.nextInt(<span class="number">10</span>) + <span class="string">"\t"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">byMath</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            System.out.print((<span class="keyword">int</span>) (Math.random() * <span class="number">11</span>) + <span class="string">"\t"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">byThreadLocalRandom</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            System.out.print(ThreadLocalRandom.current().nextInt(<span class="number">10</span>) + <span class="string">"\t"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">bySecureRandom</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SecureRandom secureRandom = <span class="keyword">new</span> SecureRandom();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            System.out.print(secureRandom.nextInt(<span class="number">10</span>) + <span class="string">"\t"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果如下：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1	9	0	8	8	6	8	7	3	4	</span><br><span class="line">cost: 1</span><br><span class="line">3	0	3	0	6	6	7	8	1	4	</span><br><span class="line">3	0	3	0	6	6	7	8	1	4	</span><br><span class="line">byRandomFixedSeed cost: 0</span><br><span class="line">1	9	7	4	9	1	8	0	7	5	</span><br><span class="line">byMath cost: 1</span><br><span class="line">9	0	9	8	0	7	9	7	6	0	</span><br><span class="line">byThreadLocalRandom cost: 1</span><br><span class="line">4	7	5	5	8	1	4	5	4	9	</span><br><span class="line">bySecureRandom cost: 501</span><br></pre></td></tr></table></figure><p></p><p>通过运行结果我们发现，固定 seed 的为 10 的 Random 生成的随机数是一样的。SecureRandom 生成 10 个随机数需要的时间最长。</p><h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><h3 id="Random-类"><a href="#Random-类" class="headerlink" title="Random 类"></a>Random 类</h3><p>Random 类提供了两个构造方法：一个不带参数的构造方法，一个带 seed 参数的构造方法。默认的构造方法其初始化的源码（解析请看注释）如下：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 无参构造方法</span><br><span class="line"> */</span><br><span class="line">public Random() &#123;</span><br><span class="line">    // 按位异或运算</span><br><span class="line">    this(seedUniquifier() ^ System.nanoTime());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 使用无锁算法产生唯一的种子</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">private static long seedUniquifier() &#123;</span><br><span class="line">    // L&apos;Ecuyer, &quot;Tables of Linear Congruential Generators of</span><br><span class="line">    // Different Sizes and Good Lattice Structure&quot;, 1999</span><br><span class="line">    for (;;) &#123;</span><br><span class="line">        // 获取 seedUniquifier 的当前值 current</span><br><span class="line">        long current = seedUniquifier.get();</span><br><span class="line">        // 当前值和 181783497276652981L 进行乘法运算，并得到结果 next</span><br><span class="line">        long next = current * 181783497276652981L;</span><br><span class="line">        // 如果当前值 current 和运算结果 next 不等则修改 seedUniquifier 值为运算结果 next</span><br><span class="line">        if (seedUniquifier.compareAndSet(current, next))</span><br><span class="line">            // 返回种子 next</span><br><span class="line">            return next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/** 初始值为 8682522807148012L 的 Long 原子类 */</span><br><span class="line">private static final AtomicLong seedUniquifier</span><br><span class="line">    = new AtomicLong(8682522807148012L);</span><br></pre></td></tr></table></figure><p></p><p>接下来，我们再看看有参数的构造方法源码（解析请看注释）：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 带有参数的构造方法</span><br><span class="line"> */</span><br><span class="line">public Random(long seed) &#123;</span><br><span class="line">    // 使用的就是 Random 类</span><br><span class="line">    if (getClass() == Random.class)</span><br><span class="line">        this.seed = new AtomicLong(initialScramble(seed));</span><br><span class="line">    else &#123;</span><br><span class="line">        // subclass might have overriden setSeed（如果使用的是 Random 的子类，有可能重写了 setSeed 方法）</span><br><span class="line">        this.seed = new AtomicLong();</span><br><span class="line">        // 保存 seed</span><br><span class="line">        setSeed(seed);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private static long initialScramble(long seed) &#123;</span><br><span class="line">    // 先异或再按位与</span><br><span class="line">    return (seed ^ multiplier) &amp; mask;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private static final long multiplier = 0x5DEECE66DL;</span><br><span class="line"></span><br><span class="line">/** 转换为二进制就是 48 个 1 */</span><br><span class="line">private static final long mask = (1L &lt;&lt; 48) - 1;</span><br></pre></td></tr></table></figure><p></p><p>然后我们再看看是如何生成随机数的：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">public int nextInt(int bound) &#123;</span><br><span class="line">    // 如果边界值小于等于 0</span><br><span class="line">    if (bound &lt;= 0)</span><br><span class="line">        // 异常</span><br><span class="line">        throw new IllegalArgumentException(BadBound);</span><br><span class="line">    // 调用 next 方法生成随机数</span><br><span class="line">    int r = next(31);</span><br><span class="line">    // 边界值减去 1</span><br><span class="line">    int m = bound - 1;</span><br><span class="line">    // 如果相与的结果为 0，说明边界值为 2 的幂次方</span><br><span class="line">    if ((bound &amp; m) == 0)  // i.e., bound is a power of 2</span><br><span class="line">        // 重新生成随机数</span><br><span class="line">        r = (int)((bound * (long)r) &gt;&gt; 31);</span><br><span class="line">    else &#123;</span><br><span class="line">        for (int u = r;</span><br><span class="line">             u - (r = u % bound) + m &lt; 0;</span><br><span class="line">             u = next(31))</span><br><span class="line">            ;</span><br><span class="line">    &#125;</span><br><span class="line">    return r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">protected int next(int bits) &#123;</span><br><span class="line">    long oldseed, nextseed;</span><br><span class="line">    AtomicLong seed = this.seed;</span><br><span class="line">    do &#123;</span><br><span class="line">        // 保存原来的 seed</span><br><span class="line">        oldseed = seed.get();</span><br><span class="line">        // 生成新 seed</span><br><span class="line">        nextseed = (oldseed * multiplier + addend) &amp; mask;</span><br><span class="line">    // 无锁算法：比较交换 seed 的值为 nextseed</span><br><span class="line">    &#125; while (!seed.compareAndSet(oldseed, nextseed));</span><br><span class="line">    // 无符号右移 17 位</span><br><span class="line">    return (int)(nextseed &gt;&gt;&gt; (48 - bits));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private static final long addend = 0xBL;</span><br></pre></td></tr></table></figure><p></p><p>通过以上代码的简单分析，我们可以知道随机数的生成是通过一定的算法算出来的，而且和 seed 有非常紧密的关系：算法是固定的，如果 seed 也固定了，就会造成上述测试结果中那样，生成的随机数完全一致的情况。如果能够“预测”seed 的值（默认的 seed 也是通过算法得到的），就有可能生成一样的随机数，说明 Random 类的安全性还有待提升。</p><p>接下来，我们再看看几段 JDK 1.8 官方文档的说明：</p><blockquote><p>An instance of this class is used to generate a stream of pseudorandom numbers. The class uses a 48-bit seed, which is modified using a linear congruential formula. (See Donald Knuth, The Art of Computer Programming, Volume 2, Section 3.2.1.)</p></blockquote><p>该类的实例用于生成伪随机数流。该类使用 48 位种子，使用线性同余公式进行修改。 （参见 Donald Knuth，计算机程序设计的艺术，第 2 卷，第 3.2.1 节。）</p><blockquote><p>If two instances of Random are created with the same seed, and the same sequence of method calls is made for each, they will generate and return identical sequences of numbers.</p></blockquote><p>如果使用相同的种子创建两个 Random 实例，并且为每个实例创建相同的方法调用序列，则它们将生成并返回相同的数字序列。</p><blockquote><p>Instances of java.util.Random are threadsafe. However, the concurrent use of the same java.util.Random instance across threads may encounter contention and consequent poor performance. Consider instead using java.util.concurrent.ThreadLocalRandom in multithreaded designs.</p></blockquote><p>java.util.Random 的实例是线程安全的。但是，跨线程并发使用相同的 java.util.Random 实例可能会遇到争用，从而导致性能不佳。请考虑在多线程设计中使用 java.util.concurrent.ThreadLocalRandom。<br>PS：这里的竞争，主要还是对 seed 的竞争，在多线程的调用下，next(int bits) 方法中对 seed 的修改并不能一次就修改成功，从而一直循环，直到修改成功。</p><blockquote><p>Instances of java.util.Random are not cryptographically secure. Consider instead using java.security.SecureRandom to get a cryptographically secure pseudo-random number generator for use by security-sensitive applications.</p></blockquote><p>java.util.Random 的实例不具有加密安全性。如果需要，请考虑使用 java.security.SecureRandom 来获取加密安全的伪随机数生成器，以供安全敏感的应用程序使用。</p><h3 id="Math"><a href="#Math" class="headerlink" title="Math"></a>Math</h3><p>我们在上面了解了 Random 类，再来看 Math 工具类就比较简单了。在 Math 类里面有一个如下的私有的静态内部类：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public static double random() &#123;</span><br><span class="line">    return RandomNumberGeneratorHolder.randomNumberGenerator.nextDouble();</span><br><span class="line">&#125;</span><br><span class="line">private static final class RandomNumberGeneratorHolder &#123;</span><br><span class="line">    static final Random randomNumberGenerator = new Random();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>对！里面就是一个静态的类成员变量 Random。生成随机数就是调用 Random 类的 nextDouble 方法。</p><h3 id="ThreadLocalRandom"><a href="#ThreadLocalRandom" class="headerlink" title="ThreadLocalRandom"></a>ThreadLocalRandom</h3><p>ThreadLocalRandom 作为 Random 的子类，重写了 Random 里面的方法，并对并发做了管理和维护，所以在多线程场景下表现比 Random 更好。</p><h3 id="SecureRandom"><a href="#SecureRandom" class="headerlink" title="SecureRandom"></a>SecureRandom</h3><p>SecureRandom 作为 Random 的子类，该类提供加密强随机数生成器，所以在性能上比 Random 就略逊一筹。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>如果没有多线程的场景，那就用 Math 来生成随机数吧，毕竟提供现成的工具类，不用自己维护实例。多线程场景，还是使用 ThreadLocalRandom。如果对安全性有一定要求，可以使用 SecureRandom，那么在性能上有一点点的影响。<br>通过对 Random 源码的部分解析，其中有 3 个彩蛋可以重点记一下：</p><ol><li>如何生成指定位数全为 1 二进制数？</li><li>如何判断一个数是不是 2 的幂次方？</li><li>什么是无锁算法（CAS）？</li></ol></div><div class="mdui-m-y-5 mdui-typo"><div class="simple-content-end mdui-valign"> 最后修改时间: 2020年02月06日 16:11:15<br> 原始链接:</div></div><div class="mdui-center mdui-text-center simple-post-author"><p> <img class="mdui-img-circle" src="https://i.loli.net/2020/02/08/yWNnZphULOdkxjf.png"><br> <span class="mdui-typo-title">Jiang Dequan</span><br><br> <button class="mdui-btn mdui-ripple simple-donation-btn"> <i class="mdui-icon mdui-icon-left material-icons">&#xe8dc;</i>稀罕作者</button></p></div><div class="mdui-divider mdui-m-t-5 mdui-m-b-1"></div><div class="mdui-m-b-1"> <a href="/tags/随机数/" class="mdui-btn mdui-btn-dense mdui-hoverable mdui-color-green simple-article-tags">随机数</a> <a href="/tags/Random/" class="mdui-btn mdui-btn-dense mdui-hoverable mdui-color-deep-purple simple-article-tags">Random</a> <a href="/tags/Math/" class="mdui-btn mdui-btn-dense mdui-hoverable mdui-color-orange simple-article-tags">Math</a> <a href="/tags/ThreadLocalRandom/" class="mdui-btn mdui-btn-dense mdui-hoverable mdui-color-teal simple-article-tags">ThreadLocalRandom</a> <a href="/tags/SecureRandom/" class="mdui-btn mdui-btn-dense mdui-hoverable mdui-color-blue simple-article-tags">SecureRandom</a></div></div></div></div><div class="mdui-row mdui-p-y-1"><div class="mdui-col-md-4 mdui-col-offset-md-1 mdui-col-xs-6 mdui-text-left mdui-typo"> <a href="/posts/377ed362/"><label class="label-post-prev">☜</label>IDEA：打造最强 IDE，这些配置你知道吗？</a></div><div class="mdui-col-md-3 mdui-col-xs-6 mdui-text-right mdui-typo"> <a href="/posts/f29d8bb0/">如何搭建一个优雅的开发环境？<label class="label-post-next">☞</label></a></div></div><div class="mdui-drawer mdui-drawer-right simple-toc-cls" id="simple-toc"><nav class="post-toc-wrap post-toc-shrink" style="width:240px"><div class="mdui-card mdui-hoverable"><div class="mdui-card-header"><h3><i class="mdui-list-item-icon mdui-icon ion-ios-flame"></i> TOC</h3></div><div class="mdui-card-content" style="height:400px;overflow-y:auto;overflow-x:hidden"><ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#随机数"><span class="post-toc-text">随机数</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#举例说明"><span class="post-toc-text">举例说明</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#原理分析"><span class="post-toc-text">原理分析</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Random-类"><span class="post-toc-text">Random 类</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Math"><span class="post-toc-text">Math</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ThreadLocalRandom"><span class="post-toc-text">ThreadLocalRandom</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#SecureRandom"><span class="post-toc-text">SecureRandom</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#小结"><span class="post-toc-text">小结</span></a></li></ol></div></div></nav></div><div class="mdui-row mdui-p-t-1 mdui-p-b-3"><div class="mdui-col-md-7 mdui-col-offset-md-1 mdui-col-xs-12 mdui-col-offset-xs-0 mdui-shadow-12"><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div id="vcomments"></div><script>new Valine({el:"#vcomments",appId:"MVdi2Xnz6HbmG6W1A7I8CAC8-gzGzoHsz",appKey:"Rl17wHDK3kufdMOx19dojo1h",placeholder:"想对作者说点什么?"})</script></div></div><script src="/js/post.js"></script></div><footer class="footer mdui-color-theme mdui-text-center" style="height:44px"><div class="mdui-valign" style="height:44px"><p class="mdui-typo-caption mdui-center"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0)</a><br> Jiang Dequan &copy; 2013 - 2020 .Power by <a href="http://hexo.io/" target="_blank"><em>Hexo</em></a> Theme <a href="https://github.com/jiangdequan/hexo-theme-mdui" target="_blank"><em>mdui</em></a></p></div></footer> <button id="simple-scroll-btn" class="mdui-fab mdui-fab-fixed mdui-ripple mdui-fab-mini mdui-color-theme-accent simple-scroll-btn-cls"> <i class="mdui-icon material-icons">&#xe5d8;</i></button><div class="mdui-dialog simple-search-result-cls" id="simple-search-result"><div class="mdui-dialog-content"><div class="mdui-list"></div></div></div><script>$(document).ready(function(){var u,o=new mdui.Dialog("#simple-search-result"),e=algoliasearch("ARMI7PH3RU","6fd6458290f8f2087f2916caba9c8975").initIndex("prod_blog"),h=$("#simple-search-result .mdui-list");$("#simple-input-search").keyup(function(){if(13===event.keyCode){var p=$(this).val();u!==p?(h.empty(),""!==p&&e.search({query:p},function(e,i){if(e)throw e;u=p;var l=i.hits,s=i.nbHits,a=i.processingTimeMS;if(h.append('<label class="mdui-list-item mdui-ripple"><img src="/images/algolia_logo.svg" style="height:18px;"/>&nbsp;&nbsp;  '+s+" results found in "+a+" ms</label>"),null==l||""===l||l.length<1)o.open();else{for(var t=0;t<l.length;t++){var n=l[t].permalink;(n=n.replace("https://jiangdequan.github.io","")).startsWith("/")||(n="/"+n);var r=l[t]._highlightResult.title.value;h.append('<a href="'+n+'" class="mdui-list-item mdui-ripple">'+r+"</a>")}o.open()}})):o.open()}})})</script><script src="https://cdn.bootcss.com/mdui/0.4.1/js/mdui.min.js"></script><script async src="//cdn.busuanzi.ibruce.info/cdn/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script><script src="https://cdn.bootcss.com/algoliasearch/3.30.0/algoliasearchLite.min.js"></script><script src="/js/common.js"></script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?28f09eb40c03df56c14ea1736cf3ec3b";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-127646245-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-127646245-1")</script></body></html>